var container=document.getElementById("game");var CONFIG={status:"start",level:1,totalLevel:6,numPerLine:7,canvasPadding:30,bulletSize:{width:1,height:10},bulletSpeed:10,enemySpeed:2,enemyFastestSpeed:5,enemySlowestSpeed:.5,enemySpeedUp:.5,enemySize:50,enemyGap:10,enemyIcon:"./img/enemy.png",enemyBoomIcon:"./img/boom.png",enemyDirection:"right",planeIcon:"./img/plane.png",planeSpeed:4,planeSize:{width:60,height:100},planeIcon:"./img/plane.png"};var GAME={init:function(opts){var self=this;this.status="start";this.score=0;this.animation="";this.elements={plane:"",enemys:[],bullets:[],getRightEnemy:function(){var length=this.enemys.length;var left=0;var index=-1;for(var i=0;i<length;i++){var enemy=this.enemys[i];if(enemy.alive&&enemy.left>left){left=enemy.left;index=i}}return index},getLeftEnemy:function(){var length=this.enemys.length;var left=999;var index=-1;for(var i=0;i<length;i++){var enemy=this.enemys[i];if(enemy.alive&&enemy.left<left){left=enemy.left;index=i}}return index},getBottomEnemy:function(){var length=this.enemys.length;for(var i=length-1;i>-1;i--){if(this.enemys[i].alive){return i}}}};this.canvas=document.querySelector("#canvas");this.context=canvas.getContext("2d");this.context.font="18px Arial";this.context.fillStyle="#fff";this.Creature.prototype.draw=function(context){var self=this;this.image.onload=function(){context.drawImage(self.image,self.left,self.top,self.width,self.height)};context.drawImage(this.image,this.left,this.top,this.width,this.height)};this.Creature.prototype.move=function(direction,speed){switch(direction){case"left":this.left-=speed;break;case"right":this.left+=speed;break;case"down":this.top+=speed;break}};this.inheritPro(this.Plane,this.Creature);this.Plane.prototype.speed=CONFIG.planeSpeed;this.inheritPro(this.Enemy,this.Creature);this.Enemy.prototype.speed=CONFIG.enemySpeed;this.Enemy.prototype.direction=CONFIG.enemyDirection;this.Enemy.prototype.setDirection=function(dir){self.Enemy.prototype.direction=dir};this.Bullet.prototype.move=function(speed){this.top-=speed};this.Bullet.prototype.draw=function(context){context.beginPath();context.strokeStyle="#fff";context.lineWidth=this.width;context.moveTo(this.left,this.top);context.lineTo(this.left,this.top+this.height);context.stroke()};this.bindEvent()},bindEvent:function(){var self=this;var playBtn=document.querySelector(".js-play");playBtn.onclick=function(){self.play()};this.keys=[];document.body.addEventListener("keydown",function(e){if(self.status!="playing"){return}var key=e.keyCode;if(self.keys.indexOf(key)===-1){if(self.keys.indexOf(32)>-1){self.keys.splice(self.keys.indexOf(32),1)}self.keys.push(key)}var plane=self.elements.plane;for(var i=0;i<self.keys.length;i++){switch(self.keys[i]){case 32:var bullet=new self.Bullet(plane.left+plane.width/2,plane.top+CONFIG.bulletSize.height,CONFIG.bulletSize.width,CONFIG.bulletSize.height,CONFIG.bulletSpeed);bullet.draw(self.context);self.elements.bullets.push(bullet);break}}});document.body.addEventListener("keyup",function(e){var key=e.keyCode;var index=self.keys.indexOf(key);if(index>-1){self.keys.splice(index,1)}console.log(self.keys)});var stopBtn=document.querySelector(".js-stop");stopBtn.addEventListener("click",function(e){if(self.animation){this.value="继续游戏";cancelAnimationFrame(self.animation);self.animation=null}else{this.value="暂停游戏";self.move()}});var endBtn=document.querySelector(".js-end");endBtn.addEventListener("click",function(e){cancelAnimationFrame(self.animation);self.failed()});var replayBtn=document.querySelectorAll(".js-replay");replayBtn.forEach(function(btn){btn.addEventListener("click",function(e){CONFIG.level=1;self.score=0;self.play()})});var speedUpBtn=document.querySelectorAll(".js-speed-up");speedUpBtn.forEach(function(btn){btn.addEventListener("click",function(e){if(self.Enemy.prototype.speed<CONFIG.enemyFastestSpeed){self.Enemy.prototype.speed+=CONFIG.enemySpeedUp}})});var speedDownBtn=document.querySelector(".js-speed-down");speedDownBtn.addEventListener("click",function(e){if(self.Enemy.prototype.speed>CONFIG.enemySlowestSpeed){self.Enemy.prototype.speed-=CONFIG.enemySpeedUp}});var nextBtn=document.querySelector(".js-next");nextBtn.addEventListener("click",function(e){if(CONFIG.level<CONFIG.totalLevel){CONFIG.level++}self.play()})},setStatus:function(status){this.status=status;container.setAttribute("data-status",status)},play:function(){this.setStatus("playing");this.createEle();this.move()},reset:function(){this.animation="";this.elements.plane=null;this.elements.enemys=[];this.elements.bullets=[];this.Enemy.prototype.speed=CONFIG.enemySpeed},createEle:function(){var self=this;this.reset();var planeLeft=this.canvas.width/2-CONFIG.planeSize.width/2;var planeTop=this.canvas.height-CONFIG.canvasPadding-CONFIG.planeSize.height;this.elements.plane=new this.Plane(self,planeLeft,planeTop,CONFIG.planeSize.width,CONFIG.planeSize.height,CONFIG.planeIcon);for(var i=0;i<CONFIG.numPerLine*CONFIG.level;i++){var enemyLeft=CONFIG.canvasPadding+(CONFIG.enemyGap+CONFIG.enemySize)*(i%CONFIG.numPerLine);var enemyTop=CONFIG.canvasPadding+CONFIG.enemySize*Math.floor(i/CONFIG.numPerLine);var enemy=new this.Enemy(self,enemyLeft,enemyTop,CONFIG.enemySize,CONFIG.enemySize,CONFIG.enemyIcon);this.elements.enemys.push(enemy)}this.draw()},draw:function(){var self=this;this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.context.fillText("分数："+this.score,20,20);this.elements.plane.draw(this.context);this.elements.bullets.forEach(function(ele){ele.draw(self.context)});this.elements.enemys.forEach(function(ele,index,enemys){if(!ele.alive&&ele.deadTime==3){ele.width=0;ele.height=0}ele.move(ele.direction,ele.speed);ele.draw(self.context);if(!ele.alive&&ele.deadTime<3){ele.deadTime++}})},preEnemyMove:function(){var enemys=this.elements.enemys;var dir=enemys[0].direction;var index=-1;if(dir==="right"){index=this.elements.getRightEnemy()}else{index=this.elements.getLeftEnemy()}if(index<0){cancelAnimationFrame(this.animation);this.success();return false}var enemy=enemys[index];var isOut=false;if(dir=="right"){var borderRight=this.canvas.width-CONFIG.canvasPadding-CONFIG.enemySize;isOut=enemy.left+enemy.speed>borderRight}else{var borderLeft=CONFIG.canvasPadding;isOut=enemy.left-enemy.speed<borderLeft}if(isOut){var borderBottom=this.canvas.height-CONFIG.canvasPadding-CONFIG.planeSize.height-CONFIG.enemySize;var index=this.elements.getBottomEnemy();var bottomEnemy=enemys[index];if(bottomEnemy.top+bottomEnemy.height>borderBottom){cancelAnimationFrame(this.animation);this.failed();return false}dir=dir=="right"?"left":"right";enemy.setDirection(dir);var self=this;enemys.forEach(function(ele){ele.move("down",50);ele.draw(self.context)})}return true},prePlaneMove:function(){var plane=this.elements.plane;for(var i=0;i<this.keys.length;i++){switch(this.keys[i]){case 37:plane.direction="left";if(plane.left-plane.speed>=CONFIG.canvasPadding){plane.move(plane.direction,plane.speed)}break;case 39:plane.direction="right";if(plane.left+plane.speed<=self.canvas.width-CONFIG.canvasPadding-CONFIG.planeSize.width){plane.move(plane.direction,plane.speed)}break}}},preBulletMove:function(){var self=this;var bullets=this.elements.bullets;var firstBullet=bullets[0];if(firstBullet){if(firstBullet.top-firstBullet.speed<0){bullets.shift()}else{for(var i=0;i<bullets.length;i++){var bullet=bullets[i];var isShoot=false;for(var j=0;j<self.elements.enemys.length;j++){var enemy=self.elements.enemys[j];if(enemy.alive&&!(enemy.left+enemy.width<bullet.left)&&!(bullet.left+bullet.width<enemy.left)&&!(enemy.top+enemy.height<bullet.top)&&!(bullet.top+bullet.height<enemy.height)){self.score++;enemy.image.src="./img/boom.png";enemy.alive=false;enemy.deadTime=0;bullets.splice(i,1);i--;isShoot=true;break}}if(!isShoot){bullet.move(CONFIG.bulletSpeed)}}}}},move:function(){var self=this;if(!this.preEnemyMove()){return}this.prePlaneMove();this.preBulletMove();this.draw();this.animation=requestAnimationFrame(this.move.bind(this))},success:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);if(CONFIG.level==CONFIG.totalLevel){this.setStatus("all-success")}else{container.querySelector(".game-success p").innerHTML="下一个Level:  "+(CONFIG.level+1);this.setStatus("success")}},failed:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.setStatus("failed");container.querySelector(".score").innerHTML=this.score},Creature:function(left,top,width,height,src){this.left=left;this.top=top;this.width=width;this.height=height;this.image=new Image;this.image.src=src},Plane:function(self,left,top,width,height,src){console.dir(self);self.Creature.call(this,left,top,width,height,src)},Enemy:function(self,left,top,width,height,src){self.Creature.call(this,left,top,width,height,src);this.alive=true},Bullet:function(left,top,width,height,speed){this.left=left;this.top=top;this.width=width;this.height=height;this.speed=speed},inheritPro:function(sub,sup){var prototype=Object.create(sup.prototype);prototype.constructor=sub;sub.prototype=prototype}};GAME.init();